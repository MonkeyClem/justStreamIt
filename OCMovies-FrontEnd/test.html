<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"  crossorigin="anonymous">

    <!-- <title>Movies List</title> -->
</head>
<body>
    <div class="container mt-5" style="background-color: #61787F; color: white; display: flex; align-items: center;">
        <img src="./image1 1.svg" alt="logo">
        <h1 class="" style="margin-left: 2rem;font-family: oswald; font-size: 40px;">Vidéos à la demande</h1>
    </div> 
    <div id = "best-movie" class="container mt-5"> 
    </div>
    <div id = "best-rating-movies" class="container mt-5">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        // SCRIPT TO GET THE BEST MOVIES 
        const apiUrlForBestMovies = "http://localhost:8000/api/v1/titles/?imdb_score_min=9&sort_by=-imdb_score";
        const fetchBestMovieDetails = async(id) => {
            const bestMovieDetailsResponse = await fetch(`http://localhost:8000/api/v1/titles/${id}`)
            const bestMovieDetails = await bestMovieDetailsResponse.json()
            return bestMovieDetails
        }

        async function fetchBestMovies() {
            let currentPage = 1; 
            let bestMovies = [];  

            try {
                while (true) {
                    const response = await fetch(`${apiUrlForBestMovies}&page=${currentPage}`);

                    console.log("response ==>",response);
                    if (!response.ok) {
                        throw new Error(`Erreur lors de la récupération de la page ${currentPage}: ${response.status}`);
                    }

                    const data = await response.json();

                    bestMovies = bestMovies.concat(data.results);

                    if (!data.next) {
                        break; 
                    }
                        
                    currentPage++; 
                }



                const movieDiv = document.getElementById("best-movie");
                const bestMovie = bestMovies[0];
                const bestRatingMovies = document.getElementById("best-rating-movies")
                console.log("bestRatingMovies :::::", bestRatingMovies)
                const bestMovieDetails = await fetchBestMovieDetails(bestMovie.id)

                movieDiv.innerHTML = `
                      <div class="group p-3 mb-5 rounded">
                                <h3>Meilleur film</h3>
                                <div class="card-body text-center" style="border: 6px solid black; display : flex">
                                    <img src="${bestMovieDetails.image_url}" style="width:227px; height:334px" />
                                    <div class ="bg-success" style="display : flex; flex-direction : column; justify-content : space-evenly; position : relative"> 
                                        <h4 class="card-title text-white" style="font-size : 48px">${bestMovie.title}</h4>
                                        <p style="font-size: 28px">${bestMovieDetails.long_description}</p>
                                        <button class="btn btn-danger" style="width : 166px; border-radius: 25; position: absolute; right : 10px; bottom : 10px">Détails</button> 
                                    </div>
                                </div>
                            </div>
                `;
                bestRatingMovies.innerHTML = `
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; background-color: blue; padding: 16px;">
                        ${bestMovies.slice(0, 6).map((movie) => `
                        <div style="flex: 1 1 calc(33.333% - 16px); position: relative; overflow: hidden; max-width: 242px; aspect-ratio: 2 / 3;">
                            <img src="${movie.image_url}" alt="${movie.title}" style="width: 100%; height: 100%; object-fit: cover;">
                            <div style="position: absolute; bottom: 50%; left: 0; right: 0; transform: translateY(50%); background-color: rgba(0, 0, 0, 0.7); color: white; text-align: center; padding: 8px; font-size: 16px; z-index: 1;">
                                ${movie.title}
                                </br>
                                <button>Détails</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                `

                return bestMovies;

            } catch (error) {
                console.error("Erreur lors de la récupération des films :", error);
                return [];
            }
}



 fetchBestMovies();





const fetchMoviesByCategory = async (category, maxMovies = 6) => {
    const baseUrl = `http://localhost:8000/api/v1/titles/?genre=${category}`;
    let movies = [];
    let currentPage = 1;

    try {
        while (movies.length < maxMovies) {
            const url = `${baseUrl}&page=${currentPage}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Erreur lors de la récupération de la catégorie "${category}" à la page ${currentPage}: ${response.status}`);
            }


            const data = await response.json();


            const resultsToAdd = maxMovies - movies.length; 
            movies = movies.concat(data.results.slice(0, resultsToAdd));


            if (!data.next) break;

            currentPage++; 
        }

        return movies;
    } catch (error) {
        console.error(`Erreur lors de la récupération des films pour la catégorie "${category}":`, error);
        return [];
    }
};

const getMovies = async () => {
    const categories = ["Adventure", "Action", "Fantasy"];
    const moviesByCategory = await Promise.all(
        categories.map((category) => fetchMoviesByCategory(category, 6))
    );

    categories.forEach((category, index) => {
        console.log(`${category} Movies:`, moviesByCategory[index]);
    });
};

getMovies();



    </script>
</body>
</html>
